---
title: "01-3_check_resid"
subtitle: "Check residence variables"
author: "Ross Gayler"
date: "2021-01-12"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
  markdown: 
    wrap: 72
---

```{r setup}
# Set up the project environment, because each Rmd file knits in a new R session
# so doesn't get the project setup from .Rprofile

# Project setup
library(here)
source(here::here("code", "setup_project.R"))

# Extra set up for the 01*.Rmd notebooks
source(here::here("code", "setup_01.R"))

# Extra set up for this notebook
# ???

# start the execution time clock
tictoc::tic("Computation time (excl. render)")
```

# Introduction

The `01*.Rmd` notebooks read the data, filter it to the subset to be
used for modelling, characterise it to understand it, check for possible
gotchas, clean it, and save it for the analyses proper.

This notebook (`01-3_check_resid`) characterises the residence variables
in the saved subset of the data. These are the residential address and
the phone number (which is tied to the address if the telephone is a
land-line).

We have no intention of using the residence variables as predictors for
entity resolution. However, they may be of use for manually checking the
results of entity resolution. Consequently, the checking done here is
minimal.

------------------------------------------------------------------------

Define the residence variables.

```{r}
vars_resid <- c(
  "unit_num", "house_num",      
  "half_code", "street_dir", "street_name", "street_type_cd", "street_sufx_cd",
  "res_city_desc", "state_cd", "zip_code",
  "area_cd", "phone_num"
)
```

Read the usable data. Remember that this consists of only the ACTIVE &
VERIFIED records.

```{r}
# Show the entity data file location
# This is set in code/file_paths.R
fs::path_file(f_entity_raw_fst)

# get data for next section of analyses
d <- fst::read_fst(
  f_entity_raw_fst, 
  columns = vars_resid
) %>% 
  tibble::as_tibble()
dim(d)
```

Look at some examples.

Residential address:

```{r}
d %>% 
  dplyr::select(unit_num : zip_code) %>% 
  dplyr::slice_sample(n = 20) %>% 
  knitr::kable()
```

Telephone number:

```{r}
d %>% 
  dplyr::select(area_cd : phone_num) %>% 
  dplyr::slice_sample(n = 20) %>% 
  knitr::kable()
```

# Dwelling

`unit_num` Residential address unit number\
`house_num` Residential address street number\
`half_code` Residential address street number half code

```{r}
d %>% 
  dplyr::select(unit_num, house_num, half_code) %>% 
  skimr::skim()
```

-   `unit_num` 8% filled

-   `house_num` 100% filled

-   `half_code` 0.3% filled

    -   Warning messages indicate some invalid multibyte strings

Look at `half_code`.

```{r}
table(d$half_code, useNA = "ifany")

d %>% 
  dplyr::filter(!is.na(half_code)) %>% 
  dplyr::select(unit_num : street_type_cd) %>% 
  dplyr::slice_sample(n = 20)
```

`half_code` appears to indicate where there are multiple buildings on
one street-numbered block. Typical values would be A, B, ...

# Street

```{r}
d %>% 
  dplyr::select(starts_with("street_")) %>% 
  skimr::skim()
```

-   `street_dir` 7% filled
-   `street_name` \~100% filled (7 missing)
-   `street_type_cd` 96% filled
-   `street_sufx_cd` 4% filled

## street_dir

`street_dir` Residential address street direction (N,S,E,W,NE,SW, etc.)

```{r}
table(d$street_dir, useNA = "ifany")
```

## street_name

`street_name` Residential address street name

Seven records are missing street name. Look at them.

```{r}
d %>% 
  dplyr::filter(is.na(street_name)) %>% 
  knitr::kable()
```

-   Seven records have no residential address. Are these homeless
    people?

Some street names are very short. Look at the distribution of length of
street name.

```{r}
summary(stringr::str_length(d$street_name))

d %>% 
  ggplot() +
  geom_histogram(aes(x = stringr::str_length(street_name)), binwidth = 1) +
  scale_y_sqrt()
```

Look at examples of short street names.

```{r}
d %>% 
  dplyr::filter(stringr::str_length(street_name) == 1) %>% 
  dplyr::select(starts_with("street_"), res_city_desc) %>%
  dplyr::slice_sample(n = 20) %>% 
  knitr::kable()

d %>% 
  dplyr::filter(stringr::str_length(street_name) == 2) %>% 
  dplyr::select(starts_with("street_"), res_city_desc) %>%
  dplyr::slice_sample(n = 20) %>% 
  knitr::kable()
```

I checked some of these examples against a map.

-   Some streets have names like A, B, C, ...
-   "JC Road" is a valid street name

Look at examples of long street names.

```{r}
d %>% 
  dplyr::filter(stringr::str_length(street_name) >= 28) %>% 
  dplyr::select(starts_with("street_"), res_city_desc) %>%
  dplyr::distinct(.keep_all = TRUE) %>% 
  dplyr::arrange(street_name) %>% 
  knitr::kable()
```

-   Long street names are multi-word phrases

    -   Some appear to have been truncated

## street_type_cd

`street_type_cd` Residential address street type (RD, ST, DR, BLVD,
etc.)

```{r}
table(d$street_type_cd, useNA = "ifany")
```

## street_sufx_cd

`street_sufx_cd` Residential address street suffix (BUS, EXT, and
directional)

```{r}
table(d$street_sufx_cd, useNA = "ifany")
```

# Locality

`res_city_desc` Residential address city name\
`state_cd` Residential address state code\
`zip_code` Residential address zip code

```{r}
d %>% 
  dplyr::select(res_city_desc : zip_code) %>% 
  skimr::skim()
```

-   `res_city_desc` \~100% filled (19 missing)
-   `state_cd` \~100% filled (19 missing)
-   `zip_code` \~100% filled (19 missing)

Look at the addresses with any missing locality variable.

```{r}
d %>% 
  dplyr::filter(is.na(res_city_desc) | is.na(state_cd) | is.na(zip_code)) %>% 
  dplyr::select(house_num : zip_code) %>%
  dplyr::distinct(.keep_all = TRUE) %>%
  dplyr::arrange(state_cd, res_city_desc, zip_code) %>% 
  knitr::kable()
```

-   Some appear to be good addresses, apart from a missing zip code
-   One appears to be a good address, apart from a missing state code
-   Some are CONFIDENTIAL addresses, with all details missing
-   Some appear to be completely missing the address (homeless persons?)

## state_cd

`state_cd` Residential address state code

```{r}
table(d$state_cd, useNA = "ifany")
```

-   Residential state codes are almost entirely Georgia

    -   There are a small number in neighbouring states (non-resident
        voters?)

## zip_code

`zip_code` Residential address zip code

The zip codes are not all the same length. Look at the distribution of
length of zip code

```{r}
table(stringr::str_length(d$zip_code), useNA = "ifany")
```

Look at the 9-digit zip codes.

```{r}
d %>% 
  dplyr::filter(stringr::str_length(zip_code) == 9) %>% 
  dplyr::select(street_name : zip_code) %>%
  dplyr::arrange(zip_code) %>% 
  knitr::kable()
```

- 5-digit and 9-digit zip codes are [valid](https://en.wikipedia.org/wiki/ZIP_Code)

# Timing {.unnumbered}

```{r echo=FALSE}
tictoc::toc()
```
