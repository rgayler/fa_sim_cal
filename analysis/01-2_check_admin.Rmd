---
title: "01-2_check_admin"
subtitle: "Check administrative variables"
author: "Ross Gayler"
date: "2021-01-11"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
  markdown: 
    wrap: 72
---

```{r setup}
# Set up the project environment, because each Rmd file knits in a new R session
# so doesn't get the project setup from .Rprofile

# Project setup
library(here)
source(here::here("code", "setup_project.R"))

# Extra set up for the 01*.Rmd notebooks
source(here::here("code", "setup_01.R"))

# Extra set up for this notebook
# ???

# start the execution time clock
tictoc::tic("Computation time (excl. render)")
```

# Introduction

The `01*.Rmd` notebooks read the data, filter it to the subset to be
used for modelling, characterise it to understand it, check for possible
gotchas, clean it, and save it for the analyses proper.

This notebook (`01-2_check_admin`) characterises the "administrative"
variables in the saved subset of the data.

We don't know any of the details on how the NCVR data is collected and
processed, so our interpretations are only educated guesses. We have no
intention of using the administrative variables as predictors for entity
resolution. However, it's possible that they may shed some light on data
quality which might influence our choice of records to be used for
modelling.

------------------------------------------------------------------------

Define the "administrative" variables.

```{r}
vars_admin <- c("county_id", "county_desc", "voter_reg_num", "registr_dt", "cancellation_dt")  
```

Read the usable data. Remember that this consists of only the ACTIVE &
VERIFIED records.

```{r}
# Show the entity data file location
# This is set in code/file_paths.R
fs::path_file(f_entity_raw_fst)

# get data for next section of analyses
d <- fst::read_fst(
  f_entity_raw_fst, 
  columns = c(vars_admin, "age") # get age as well
) %>% 
  tibble::as_tibble()
dim(d)
```

# county_id & county_desc

`county_id` County identification number\
`county_desc` County description

```{r}
d$county_id %>% as.integer() %>% summary()

d$county_id %>% as.integer() %>% table(useNA = "ifany")

ggplot(d) +
  geom_bar(aes(x = forcats::fct_infreq(county_id))) +
  theme(panel.grid.major = element_blank(), 
        axis.text.x = element_text(angle = 90, hjust=1, vjust = 0.5)
  )
```

-   Never missing
-   Integer 1 .. 100 (as strings)
-   A small number of populous counties with a long tail of small
    counties

Check that the county descriptions are in a 1-1 relationship with the
county IDs.

```{r}
d$county_desc %>% unique() %>% length()

paste(d$county_id, d$county_desc) %>% unique() %>% length()

(d$county_desc %>% unique() %>% length()) ==
  (paste(d$county_id, d$county_desc) %>% unique() %>% length())
```

-   100 unique values
-   In 1-1 relationship with `county_id`

They look reasonable, to the extent that I can tell without knowing
anything about the counties.

# voter_reg_num

`voter_reg_num` Voter registration number (unique by county)

```{r}
d$voter_reg_num %>% head()
d$voter_reg_num %>% tail()

d$voter_reg_num %>% unique() %>% length()

summary(as.integer(d$voter_reg_num))
```

-   \~1.8M unique values
-   Never missing
-   Integer 1 .. \~400M (as strings)
-   12-digit integers with leading zeroes

Check whether `county_id` $\times$ `voter_reg_num` is unique, as
claimed.

```{r}
# number of records
nrow(d)

# number of unique county_id x voter_reg_num combinations
paste(d$county_id, d$voter_reg_num) %>% unique() %>% length()

nrow(d) ==
  (paste(d$county_id, d$voter_reg_num) %>% unique() %>% length())
```

-   `county_id` $\times$ `voter_reg_num` is unique, as claimed

# registr_dt

`registr_dt` Voter registration date

```{r}
d$registr_dt %>% summary()

x <- d %>% 
  dplyr::filter(registr_dt > lubridate::ymd("2005-11-25")) # after snapshot date

nrow(x)

x %>% 
  dplyr::arrange(registr_dt) %>% 
  knitr::kable()
```

-   Never missing

-   18 records have registration date after the snapshot date

    -   Range from a couple of years to millennia in the future
    -   Presumably these are typos

-   Some records have early registration dates

Investigate the early registration dates. First form a view on how early
is too early by finding the maximum age and assuming registration at 21
years of age.

```{r}
d$age %>% as.integer() %>% summary()

d$age %>% as.integer() %>% quantile(probs = c(0.003, 0.004, 0.995, 0.996, 0.997, 0.998, 0.999))

d %>% 
  dplyr::mutate(age = as.integer(age)) %>% 
  dplyr::filter(age >= 80) %>% 
  ggplot() +
  geom_vline(xintercept = c(105, 125, 204), colour = "red") +
  geom_histogram(aes(x = age), binwidth = 1) +
  scale_y_log10()
```

That just opened another can of worms. Without considering `age` in
detail, it appears that the maximum accurate age is not more than 120
years.

Assume that the maximum possible voter age is 116 years. The minimum
registration age in North Carolina is 16 years (although I have no idea
what it was 100 years ago). Therefore, assume that the oldest possible
voter could have registered 100 years prior to the snapshot date. That
is, regard any registration earlier than 1905-11-25 as very unlikely to
be correct.

Now look at the distribution of registration dates that are no later
than the snapshot date.

```{r}
d %>% 
  dplyr::filter(registr_dt <= lubridate::ymd("2005-11-25")) %>% 
  ggplot() +
  geom_histogram(aes(x = registr_dt), binwidth = 365.25) + # 1yr bins
  scale_y_sqrt()
```

-   Registration dates before \~1935 are suspect
-   There is a large spike of registrations in 1900. These are bound to
    be errors.

Look at the relationship between age and registration date.

First look at all the records (excluding those with registration date
after the snapshot date).

```{r}
d %>% 
  dplyr::mutate(age = as.integer(age)) %>% 
  dplyr::filter(registr_dt <= lubridate::ymd("2005-11-25")) %>%
  ggplot() +
  geom_hex(aes(x = age, y = registr_dt, fill = stat(log10(count))), binwidth = c(1, 365.25)) # 1yr bins x&y
```

Now exclude the manifestly weird regions.

```{r}
d %>% 
  dplyr::mutate(age = as.integer(age)) %>% 
  dplyr::filter(
    dplyr::between(registr_dt, lubridate::ymd("1901-01-01"), lubridate::ymd("2005-11-25")),
    dplyr::between(age, 18, 104)
  ) %>%
  ggplot() +
  geom_hex(aes(x = age, y = registr_dt, fill = stat(log10(count))), binwidth = c(1, 365.25)) # 1yr bins x&y
```

- The blue'ish upper triangle corresponds to people who were at least 18 years old at registration.
- The black fringe below the blue-ish upper triangle corresponds to people who were less that 18 years old at registration.
- The negative diagonal line corresponds to people who would have been zero years old at registration.
- The points below the negative diagonal line correspond to people who appear to have been registered before they were born.

- Most registration dates are consistent with age
- A significant fraction of registration dates are *inconsistent* with age.

# cancellation_dt

`cancellation_dt` Cancellation date

```{r}
d$cancellation_dt %>% summary()

table(missing = is.na(d$cancellation_dt))
table(missing = is.na(d$cancellation_dt)) %>% prop.table() %>% round(3)

x <- d %>% 
  dplyr::filter(!is.na(cancellation_dt)) # not missing

x %>% 
  ggplot() +
  geom_histogram(aes(x = cancellation_dt), binwidth = 7) + # 1wk bins
  scale_y_sqrt()
```

-   Almost always missing
    - `r nrow(x)` (`r round(100*nrow(x)/nrow(d), 1)`%) nonmissing
- Concentrated in 1996 and early 1997    

It is not clear what having a cancellation date means for records that are flagged as ACTIVE & VERIFIED.
Perhaps they had been removed from the electoral roll in the past and subsequently reinstated.

# Timing {.unnumbered}

```{r echo=FALSE}
tictoc::toc()
```
