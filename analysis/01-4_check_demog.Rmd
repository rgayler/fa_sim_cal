---
title: "01-4_check_demog"
subtitle: "Check demographic variables"
author: "Ross Gayler"
date: "2021-01-12"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
  markdown: 
    wrap: 72
---

```{r setup}
# Set up the project environment, because each Rmd file knits in a new R session
# so doesn't get the project setup from .Rprofile

# Project setup
library(here)
source(here::here("code", "setup_project.R"))

# Extra set up for the 01*.Rmd notebooks
source(here::here("code", "setup_01.R"))

# Extra set up for this notebook
# ???

# start the execution time clock
tictoc::tic("Computation time (excl. render)")
```

# Introduction

The `01*.Rmd` notebooks read the data, filter it to the subset to be
used for modelling, characterise it to understand it, check for possible
gotchas, clean it, and save it for the analyses proper.

This notebook (`01-4_check_demog`) characterises the demographic
variables in the saved subset of the data. These are the non-name
variables that are reasonably interpretable as properties of the person.

We will probably use some of these variables as predictors in a
compatibility model and/or as blocking variables.

------------------------------------------------------------------------

Define the demographic variables.

```{r}
vars_resid <- c(
  "sex_code", "sex", "age", "birth_place" 
)
```

Read the usable data. Remember that this consists of only the ACTIVE &
VERIFIED records.

```{r}
# Show the entity data file location
# This is set in code/file_paths.R
fs::path_file(f_entity_raw_fst)

# get data for next section of analyses
d <- fst::read_fst(
  f_entity_raw_fst, 
  columns = vars_resid
) %>% 
  tibble::as_tibble()
dim(d)
```

Take a quick look at the distributions.

```{r}
d %>% skimr::skim()
```

- `sex_code` 100% filled
- `sex` 100% filled
- `age` 100% filled
- `birth_place` 82% filled

# sex_code & sex

`sex_code` Gender code  
`sex` Gender description

```{r}
d %>% 
  with(table(sex_code, sex, useNA = "ifany"))
```

- `sex_code` and `sex` in 1-1 relationship

# birth_place

`birth_place` Birth place  

```{r}
table(d$birth_place,  useNA = "ifany") %>% sort() %>% rev()
```

- `birth_place` values appear to be 2-character [US state abbreviations](https://en.wikipedia.org/wiki/List_of_U.S._state_and_territory_abbreviations)
- OC might mean "other country"
- VI, GU, AS are probably Virgin Islands, Guam, American Samoa

# age

`age` Age (years)

I presume that the source documents actually record date of birth rather than age,
and that age is reported in these files as a gesture to privacy.

Look at the distribution of age.

```{r}
x <- d %>% 
  dplyr::mutate(age = as.integer(age))
                
x$age %>% summary()

x$age %>% quantile(probs = c(0.003, 0.004, 0.995, 0.996, 0.997, 0.998, 0.999))

x %>% 
  # dplyr::filter(age >= 80) %>% 
  ggplot() +
  geom_vline(xintercept = c(17, 105, 125, 204), colour = "orange") +
  geom_histogram(aes(x = age), binwidth = 1) +
  scale_y_log10()
```

- Voters may be pre-registered at 17 years
- The ages less than 17 years (especially zero) are effectively missing
- The spikes at 105, 125, and 204 years must be from some special process which generates those specific ages.
- Any age greater than or equal to 105 years, seems very implausible.

# Timing {.unnumbered}

```{r echo=FALSE}
tictoc::toc()
```
