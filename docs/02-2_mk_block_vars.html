<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Ross Gayler" />

<meta name="date" content="2021-01-24" />

<title>02-2_mk_block_vars</title>

<script src="site_libs/header-attrs-2.6/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<link rel="icon" href="https://github.com/workflowr/workflowr-assets/raw/master/img/reproducible.png">
<!-- Add a small amount of space between sections. -->
<style type="text/css">
div.section {
  padding-top: 12px;
}
</style>



<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>





<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Frequency-Aware Similarity Calibration</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="about.html">About</a>
</li>
<li>
  <a href="license.html">License</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/rgayler/fa_sim_cal">
    <span class="fas fa-github"></span>
     
    Source code
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">02-2_mk_block_vars</h1>
<h3 class="subtitle">Make blocking variables</h3>
<h4 class="author">Ross Gayler</h4>
<h4 class="date">2021-01-24</h4>

</div>


<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-report" data-toggle="collapse" data-target="#workflowr-report">
<span class="glyphicon glyphicon-list" aria-hidden="true"></span>
workflowr
<span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
</button>
</p>
<div id="workflowr-report" class="collapse">
<ul class="nav nav-tabs">
<li class="active">
<a data-toggle="tab" href="#summary">Summary</a>
</li>
<li>
<a data-toggle="tab" href="#checks">
Checks <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
</a>
</li>
<li>
<a data-toggle="tab" href="#versions">Past versions</a>
</li>
</ul>
<div class="tab-content">
<div id="summary" class="tab-pane fade in active">
<p>
<strong>Last updated:</strong> 2021-01-27
</p>
<p>
<strong>Checks:</strong>
<span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
7
<span class="glyphicon glyphicon-exclamation-sign text-danger" aria-hidden="true"></span>
0
</p>
<p>
<strong>Knit directory:</strong>
<code>fa_sim_cal/</code>
<span class="glyphicon glyphicon-question-sign" aria-hidden="true" title="This is the local directory in which the code in this file was executed.">
</span>
</p>
<p>
This reproducible <a href="http://rmarkdown.rstudio.com">R Markdown</a>
analysis was created with <a
  href="https://github.com/jdblischak/workflowr">workflowr</a> (version
1.6.2). The <em>Checks</em> tab describes the
reproducibility checks that were applied when the results were created.
The <em>Past versions</em> tab lists the development history.
</p>
<hr>
</div>
<div id="checks" class="tab-pane fade">
<div id="workflowr-checks" class="panel-group">
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRMarkdownfilestronguptodate">
<span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
<strong>R Markdown file:</strong> up-to-date
</a>
</p>
</div>
<div id="strongRMarkdownfilestronguptodate" class="panel-collapse collapse">
<div class="panel-body">
<p>Great! Since the R Markdown file has been committed to the Git repository, you
know the exact version of the code that produced these results.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongEnvironmentstrongempty">
<span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
<strong>Environment:</strong> empty
</a>
</p>
</div>
<div id="strongEnvironmentstrongempty" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! The global environment was empty. Objects defined in the global
environment can affect the analysis in your R Markdown file in unknown ways.
For reproduciblity it’s best to always run the code in an empty environment.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSeedstrongcodesetseed20201104code">
<span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
<strong>Seed:</strong> <code>set.seed(20201104)</code>
</a>
</p>
</div>
<div id="strongSeedstrongcodesetseed20201104code" class="panel-collapse collapse">
<div class="panel-body">
<p>The command <code>set.seed(20201104)</code> was run prior to running the code in the R Markdown file.
Setting a seed ensures that any results that rely on randomness, e.g.
subsampling or permutations, are reproducible.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSessioninformationstrongrecorded">
<span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
<strong>Session information:</strong> recorded
</a>
</p>
</div>
<div id="strongSessioninformationstrongrecorded" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Recording the operating system, R version, and package versions is
critical for reproducibility.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongCachestrongnone">
<span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
<strong>Cache:</strong> none
</a>
</p>
</div>
<div id="strongCachestrongnone" class="panel-collapse collapse">
<div class="panel-body">
<p>Nice! There were no cached chunks for this analysis, so you can be confident
that you successfully produced the results during this run.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongFilepathsstrongrelative">
<span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
<strong>File paths:</strong> relative
</a>
</p>
</div>
<div id="strongFilepathsstrongrelative" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Using relative paths to the files within your workflowr project
makes it easier to run your code on other machines.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRepositoryversionstrongahrefhttpsgithubcomrgaylerfasimcaltree1563ef0686506c704138559dda765cc862c30630targetblank1563ef0a">
<span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
<strong>Repository version:</strong> <a href="https://github.com/rgayler/fa_sim_cal/tree/1563ef0686506c704138559dda765cc862c30630" target="_blank">1563ef0</a>
</a>
</p>
</div>
<div id="strongRepositoryversionstrongahrefhttpsgithubcomrgaylerfasimcaltree1563ef0686506c704138559dda765cc862c30630targetblank1563ef0a" class="panel-collapse collapse">
<div class="panel-body">
<p>
Great! You are using Git for version control. Tracking code development and
connecting the code version to the results is critical for reproducibility.
</p>
<p>
The results in this page were generated with repository version <a href="https://github.com/rgayler/fa_sim_cal/tree/1563ef0686506c704138559dda765cc862c30630" target="_blank">1563ef0</a>.
See the <em>Past versions</em> tab to see a history of the changes made to the
R Markdown and HTML files.
</p>
<p>
Note that you need to be careful to ensure that all relevant files for the
analysis have been committed to Git prior to generating the results (you can
use <code>wflow_publish</code> or <code>wflow_git_commit</code>). workflowr only
checks the R Markdown file, but you know if there are other scripts or data
files that it depends on. Below is the status of the Git repository when the
results were generated:
</p>
<pre><code>
Ignored files:
    Ignored:    .Rhistory
    Ignored:    .Rproj.user/
    Ignored:    .tresorit/
    Ignored:    data/VR_20051125.txt.xz
    Ignored:    output/blk_char.fst
    Ignored:    output/ent_blk.fst
    Ignored:    output/ent_cln.fst
    Ignored:    output/ent_raw.fst
    Ignored:    renv/library/
    Ignored:    renv/staging/

</code></pre>
<p>
Note that any generated files, e.g. HTML, png, CSS, etc., are not included in
this status report because it is ok for generated content to have uncommitted
changes.
</p>
</div>
</div>
</div>
</div>
<hr>
</div>
<div id="versions" class="tab-pane fade">

<p>
These are the previous versions of the repository in which changes were made
to the R Markdown (<code>analysis/02-2_mk_block_vars.Rmd</code>) and HTML (<code>docs/02-2_mk_block_vars.html</code>)
files. If you’ve configured a remote Git repository (see
<code>?wflow_git_remote</code>), click on the hyperlinks in the table below to
view the files as they were in that past version.
</p>
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
File
</th>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
<th>
Message
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/rgayler/fa_sim_cal/blob/1563ef0686506c704138559dda765cc862c30630/analysis/02-2_mk_block_vars.Rmd" target="_blank">1563ef0</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-01-27
</td>
<td>
Save characterisation of blocking variables
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/rgayler/fa_sim_cal/blob/91333b0ca4741461e9f10db56d76fd987c266df5/analysis/02-2_mk_block_vars.Rmd" target="_blank">91333b0</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-01-27
</td>
<td>
Save blocking variables to a separate file
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/rgayler/fa_sim_cal/0d30c5bdc45b74957e36aec8f0b95ae7080f36c9/docs/02-2_mk_block_vars.html" target="_blank">0d30c5b</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-01-26
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/rgayler/fa_sim_cal/blob/e76546b6cfc7b3755f6fa0ebbeb19a981c77e4aa/analysis/02-2_mk_block_vars.Rmd" target="_blank">e76546b</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-01-26
</td>
<td>
Add 02-2 mk block vars
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/rgayler/fa_sim_cal/blob/bb4205db4e515dd837e1dc632b4e584fa9f9b4eb/analysis/02-2_mk_block_vars.Rmd" target="_blank">bb4205d</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-01-26
</td>
<td>
End of day
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/rgayler/fa_sim_cal/blob/8ca2c76d9fd21ffdc2f7c318cb87544f8529f9a6/analysis/02-2_mk_block_vars.Rmd" target="_blank">8ca2c76</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-01-25
</td>
<td>
End of day
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/rgayler/fa_sim_cal/blob/f872e6be52202d8d46b89be7aa559282192a32be/analysis/02-2_mk_block_vars.Rmd" target="_blank">f872e6b</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-01-24
</td>
<td>
End of day
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/rgayler/fa_sim_cal/blob/6df8db78ff0ddb04e22f2a305363710f6558cbb6/analysis/02-2_mk_block_vars.Rmd" target="_blank">6df8db7</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-01-24
</td>
<td>
End of day
</td>
</tr>
</tbody>
</table>
</div>
<hr>
</div>
</div>
</div>
<pre class="r"><code># Set up the project environment, because each Rmd file knits in a new R session
# so doesn&#39;t get the project setup from .Rprofile

# Project setup
library(here)
source(here::here(&quot;code&quot;, &quot;setup_project.R&quot;))</code></pre>
<pre><code>── Attaching packages ─────────────────────────────────────── tidyverse 1.3.0 ──</code></pre>
<pre><code>✓ ggplot2 3.3.3     ✓ purrr   0.3.4
✓ tibble  3.0.5     ✓ dplyr   1.0.3
✓ tidyr   1.1.2     ✓ stringr 1.4.0
✓ readr   1.4.0     ✓ forcats 0.5.0</code></pre>
<pre><code>── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
x dplyr::filter() masks stats::filter()
x dplyr::lag()    masks stats::lag()</code></pre>
<pre class="r"><code># Extra set up for the 02*.Rmd notebooks
source(here::here(&quot;code&quot;, &quot;setup_02.R&quot;))

# Extra set up for this notebook
# ???

# start the execution time clock
tictoc::tic(&quot;Computation time (excl. render)&quot;)</code></pre>
<div id="introduction" class="section level1" number="1">
<h1><span class="header-section-number">1</span> Introduction</h1>
<p>This notebook (<code>02-2_mk_block_vars</code>) constructs the potential blocking
variables identified in the previous notebook:</p>
<ul>
<li>(sex, age)</li>
<li>(age, county)</li>
<li>(sex, age, county)</li>
</ul>
<p>Show the assumed range of useful block sizes.</p>
<pre class="r"><code># Arbitrary lower and upper bound on useful block size
# These are set in setup_02.R
blk_sz_min</code></pre>
<pre><code>[1] 50</code></pre>
<pre class="r"><code>blk_sz_max</code></pre>
<pre><code>[1] 50000</code></pre>
</div>
<div id="read-data" class="section level1" number="2">
<h1><span class="header-section-number">2</span> Read data</h1>
<p>Read the usable data. Remember that this consists of only the ACTIVE &amp;
VERIFIED records.</p>
<pre class="r"><code># Show the entity data file location
# This is set in code/file_paths.R
fs::path_file(f_entity_cln_fst)</code></pre>
<pre><code>[1] &quot;ent_cln.fst&quot;</code></pre>
<pre class="r"><code># get entity data
d &lt;- fst::read_fst(
  f_entity_cln_fst,
  columns = c(&quot;id&quot;, &quot;sex&quot;, &quot;age_cln&quot;, &quot;age_cln_miss&quot;, &quot;birth_place&quot;, &quot;county_id&quot;)
  ) %&gt;% 
  tibble::as_tibble()

dim(d)</code></pre>
<pre><code>[1] 4099699       6</code></pre>
</div>
<div id="missing-values" class="section level1" number="3">
<h1><span class="header-section-number">3</span> Missing values</h1>
<p>Identify the missing values in the blocking variables and flag those
records as exclusions for blocking and modelling.</p>
<p>Sex and age have missing values, county ID does not.</p>
<pre class="r"><code># updating d is probably poor form
# but I am only adding variables, so it is idempotent
d &lt;- d %&gt;% 
  dplyr::mutate(
    excl_blk_age_county_miss = age_cln_miss,
    excl_blk_sex_age_miss = sex == &quot;UNK&quot; | age_cln_miss,
    excl_blk_sex_age_county_miss = sex == &quot;UNK&quot; | age_cln_miss
  )

d %&gt;% 
  dplyr::select(starts_with(&quot;excl_blk_&quot;)) %&gt;% 
  summary()</code></pre>
<pre><code> excl_blk_age_county_miss excl_blk_sex_age_miss excl_blk_sex_age_county_miss
 Mode :logical            Mode :logical         Mode :logical               
 FALSE:4068644            FALSE:4053064         FALSE:4053064               
 TRUE :31055              TRUE :46635           TRUE :46635                 </code></pre>
<ul>
<li>(age, county) excludes ~31k (~0.8%) of records from blocking and
modelling.</li>
<li>(sex, age) and (sex, age, county) excludes ~47k (~1.1%) of records
from blocking and modelling.</li>
</ul>
</div>
<div id="sex-age" class="section level1" number="4">
<h1><span class="header-section-number">4</span> (sex, age)</h1>
<p>There are only 4 blocks in (sex, age) that are too small. This can be
fixed with a small amount of age pooling.</p>
<p>The 17 year old and oldest age groups are the smallest, so they will
need pooling with other age groups.</p>
<p>The ordering of age is meaningful, so only pool adjacent ages (in order
to maintain the meaningfulness of the ordering).</p>
<p>Age will be combined with sex, so it is the size of the combined (sex,
age) blocks which is relevant.</p>
<p>The distribution of age is likely to be different for males and females.
We could have different pooling of age for males and females. However,
for simplicity I will use the same pooling of age for males and females.</p>
<p>Look at the distribution of block sizes for the relevant age groups.</p>
<pre class="r"><code>d %&gt;% 
  dplyr::filter(!excl_blk_sex_age_miss &amp;
                  (age_cln &lt;= 20 | age_cln &gt;= 95)) %&gt;%
  with(table(age_cln, sex))</code></pre>
<pre><code>       sex
age_cln FEMALE  MALE
    17      23    19
    18   10516  9962
    19   35091 31367
    20   36470 31101
    95    1347   439
    96     995   368
    97     777   251
    98     536   174
    99     409   110
    100    320    95
    101    332   182
    102    152    43
    103    130    47
    104    217   151</code></pre>
<ul>
<li><p>Pool the 17 year olds with the 18 year olds</p></li>
<li><p>Pooling 102 with 103 would be adequate.</p>
<ul>
<li>However the spikes of records at 101 and 104 are somewhat
suspect. So I will pool all the records with ages over 100 in
order to put all the questionable records in the one block.</li>
</ul></li>
</ul>
<p>Characterise the newly constructed (sex, age) blocking variable.</p>
<pre class="r"><code># construct the (sex, age) blocking variable

# updating d is probably poor form
# but I am only adding variables, so it is idempotent
d &lt;- d %&gt;% 
  dplyr::mutate(
    blk_age = dplyr::case_when(
      excl_blk_sex_age_miss  ~ NA_integer_, # make value NA for safety
      # code using NA is likely to fail if I forget to exclude these cases
      age_cln == 17          ~ 18L, # map 17 to 18
      age_cln &gt;= 101         ~ 101L, # map all ages &gt;= 101 to 101
      TRUE                   ~ age_cln # all ages &lt; 101, accept as is
    ),
    # create the new combined blocking variable
    blk_sex_age = dplyr::if_else(excl_blk_sex_age_miss,
                                 NA_character_, # make value NA for safety
                                 paste0(&quot;Sex=&quot;, sex,  &quot;:AgeGrp=&quot;, blk_age)
    )
  ) %&gt;% 
  dplyr::select(-blk_age) # we won&#39;t use age alone as a blocking variable

# calculate the distribution of block sizes
d_blk &lt;- d %&gt;% 
  dplyr::filter(!excl_blk_sex_age_miss) %&gt;% 
  dplyr::count(blk_sex_age, name = &quot;blk_sz&quot;) 

# number of blocks
nrow(d_blk)</code></pre>
<pre><code>[1] 168</code></pre>
<pre class="r"><code># summary of distribution of block sizes
summary(d_blk$blk_sz)</code></pre>
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
     95   10443   28838   24125   37752   47190 </code></pre>
<pre class="r"><code># distribution of block sizes
d_blk %&gt;% 
  ggplot(aes(x = blk_sz)) +
  geom_vline(xintercept = c(blk_sz_min, blk_sz_max), colour = &quot;blue&quot;) +
  # geom_jitter(width = 0.35, alpha = 0.2) +
  geom_histogram(bins = 10, boundary = log10(blk_sz_max), alpha = 0.5) +
  geom_rug(colour = &quot;dark grey&quot;, alpha = 0.5) +
  geom_boxplot(outlier.shape = NA, colour = &quot;red&quot;, alpha = 0, size = 1, width = 5) +
  scale_x_log10(n.breaks = 7) + annotation_logticks(sides = &quot;b&quot;) +
  theme(panel.grid.minor.x = element_blank()) + 
  xlab(&quot;Block size (records)&quot;) + ylab(&quot;Count (blocks)&quot;)</code></pre>
<p><img src="figure/02-2_mk_block_vars.Rmd/unnamed-chunk-5-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-5-1">
Past versions of unnamed-chunk-5-1.png
</button>
</p>
<div id="fig-unnamed-chunk-5-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/rgayler/fa_sim_cal/blob/0d30c5bdc45b74957e36aec8f0b95ae7080f36c9/docs/figure/02-2_mk_block_vars.Rmd/unnamed-chunk-5-1.png" target="_blank">0d30c5b</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-01-26
</td>
</tr>
</tbody>
</table>
</div>
</div>
<ul>
<li><p>168 blocks</p></li>
<li><p>100% of blocks in the useful size range and covering most of the
range</p>
<ul>
<li>Minimum block size: 95 records</li>
<li>Maximum block size: 47,190 records</li>
</ul></li>
<li><p>Mean block size (most relevant for computational effort): ~24k
records</p></li>
<li><p>The block sizes are concentrated at the higher end of the range (on
a logarithmic size scale)</p></li>
</ul>
</div>
<div id="age-county" class="section level1" number="5">
<h1><span class="header-section-number">5</span> (age, county)</h1>
<p>There are 1,759 (21%) blocks in (age, county) that are too small. None
are too large and the largest block is significantly smaller than the
upper bound on useful block size. I hope this can be fixed with some
aggressive pooling.</p>
<p>Both age and county are able to be pooled. The ordering of age is
meaningful so it makes most sense to pool adjacent age values to
maintain the ordering. The county IDs are not ordered, so there is no
obvious constraint on which counties should be pooled.</p>
<p>Prefer to pool age because the basis of pooling is clear. The fraction
of records at each age is never large, so we have good control over the
boundaries between pooled ages.</p>
<pre class="r"><code># get the block sizes for age and county in isolation
d_blk_age &lt;- d %&gt;% 
  dplyr::filter(!excl_blk_age_county_miss) %&gt;% 
  dplyr::count(age_cln, name = &quot;blk_sz&quot;) 

d_blk_cnty &lt;- d %&gt;% 
  dplyr::filter(!excl_blk_age_county_miss) %&gt;% 
  dplyr::count(county_id, name = &quot;blk_sz&quot;) 

# summaries of block sizes for age and county in isolation
summary(d_blk_age$blk_sz)</code></pre>
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
     42   17047   53492   46235   74110   86956 </code></pre>
<pre class="r"><code>summary(d_blk_cnty$blk_sz)</code></pre>
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   1027   12368   20889   40686   48004  410466 </code></pre>
<p>For county ID, the maximum block size is 410,466 records and the minimum
block size is 1,027 records.</p>
<ul>
<li><p>To reduce the maximum block size to 50k records we need to combine
it with an age group with no more than 50,000 / 410,466 =
12% of the records.</p></li>
<li><p>To reduce the minimum block size to 50 records we need to combine it
with an age group with no less than 50 / 1,027 =
5% of the records.</p></li>
<li><p>The previous points assume that age and county are independent,
which is unlikely to be exactly true. So the figures calculated here
should be regarded as back of the envelope approximations.</p></li>
<li><p>The largest pooled age group is 12% of records and the smallest is
5%. That leaves 83% of the records to be distributed over the pooled
groups of intermediate size.</p>
<ul>
<li>The intermediate pooled groups can’t be larger than the largest
group, so there must be at least ceiling(83 / 12) =
7 intermediate groups.</li>
<li>The intermediate pooled groups can’t be smaller than the
smallest group, so there must be no more than floor(83 / 5) =
16 intermediate groups.</li>
</ul></li>
<li><p>So, there must be between 5 and 16 intermediate pooled age groups.</p>
<ul>
<li>Use 10 intermediate groups because experimentation shows this
gives pleasing results with the following code.</li>
</ul></li>
<li><p>Aim for the intermediate group sizes to be equally spaced on a
linear probability scale between the sizes of the largest and
smallest pooled groups.</p>
<ul>
<li>The age groups are smaller for the higher ages, so make the
smallest pooled age group correspond to the highest ages to
provide finer control of the pooled group boundaries where the
pooled groups are smallest.</li>
</ul></li>
</ul>
<p>The target boundaries for the age groups are calculated as follows:</p>
<pre class="r"><code>n_grp &lt;- 10 + 1 + 1 # 10 intermediate + 1 largest + 1 smallest

n_rec &lt;- sum(d_blk_age$blk_sz) # number of records

p_max &lt;- 0.12 # fraction of records in largest group
p_min &lt;- 0.05 # fraction of records in smallest group

groups &lt;- tibble::tibble(
  grp = 1:n_grp
)

groups &lt;- groups %&gt;% 
  dplyr::mutate(
    p_raw = # raw fraction of records in each group (do NOT sum to 1)
      seq(from = p_max, to = p_min, length.out = n_grp), # intermediate probs equally spaced on linear scale
    
    p_grp = # fraction of records in each group (normalised to sum to 1)
      dplyr::if_else(grp %in% c(1, n_grp),
                     p_raw,
                     (1.0 - (p_max + p_min)) * p_raw / (sum(p_raw) - (p_max + p_min))
      ),
    
    p_cum = # cumulative fraction of records at the top boundary of each group
      cumsum(p_grp),
    
    rec_cut = # nearest record to group boundary
      round(p_cum * n_rec)
  )

# look at the results of the group size calculation
groups %&gt;% 
  knitr::kable(format.args = list(big.mark = &quot;,&quot;))</code></pre>
<table>
<thead>
<tr class="header">
<th align="right">grp</th>
<th align="right">p_raw</th>
<th align="right">p_grp</th>
<th align="right">p_cum</th>
<th align="right">rec_cut</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">0.1200000</td>
<td align="right">0.1200000</td>
<td align="right">0.1200000</td>
<td align="right">488,237</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">0.1136364</td>
<td align="right">0.1109626</td>
<td align="right">0.2309626</td>
<td align="right">939,704</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">0.1072727</td>
<td align="right">0.1047487</td>
<td align="right">0.3357112</td>
<td align="right">1,365,889</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">0.1009091</td>
<td align="right">0.0985348</td>
<td align="right">0.4342460</td>
<td align="right">1,766,792</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="right">0.0945455</td>
<td align="right">0.0923209</td>
<td align="right">0.5265668</td>
<td align="right">2,142,413</td>
</tr>
<tr class="even">
<td align="right">6</td>
<td align="right">0.0881818</td>
<td align="right">0.0861070</td>
<td align="right">0.6126738</td>
<td align="right">2,492,752</td>
</tr>
<tr class="odd">
<td align="right">7</td>
<td align="right">0.0818182</td>
<td align="right">0.0798930</td>
<td align="right">0.6925668</td>
<td align="right">2,817,808</td>
</tr>
<tr class="even">
<td align="right">8</td>
<td align="right">0.0754545</td>
<td align="right">0.0736791</td>
<td align="right">0.7662460</td>
<td align="right">3,117,582</td>
</tr>
<tr class="odd">
<td align="right">9</td>
<td align="right">0.0690909</td>
<td align="right">0.0674652</td>
<td align="right">0.8337112</td>
<td align="right">3,392,074</td>
</tr>
<tr class="even">
<td align="right">10</td>
<td align="right">0.0627273</td>
<td align="right">0.0612513</td>
<td align="right">0.8949626</td>
<td align="right">3,641,284</td>
</tr>
<tr class="odd">
<td align="right">11</td>
<td align="right">0.0563636</td>
<td align="right">0.0550374</td>
<td align="right">0.9500000</td>
<td align="right">3,865,212</td>
</tr>
<tr class="even">
<td align="right">12</td>
<td align="right">0.0500000</td>
<td align="right">0.0500000</td>
<td align="right">1.0000000</td>
<td align="right">4,068,644</td>
</tr>
</tbody>
</table>
<p>Now construct functions to map from age to pooled age group.</p>
<pre class="r"><code># map from cumulative record number to group number
cumrec_to_grp &lt;- stepfun(
  x = c(1L, groups$rec_cut), # x value is the upper/right boundary of each group
  y = c(1L, 1L, groups$grp),
  right = FALSE,
  f = 1 # use the x value to the right when interpolating
)

cumrec_to_grp</code></pre>
<pre><code>Step function
Call: stepfun(x = c(1L, groups$rec_cut), y = c(1L, 1L, groups$grp), 
    right = FALSE, f = 1)
 x[1:13] =      1, 4.8824e+05, 9.397e+05,  ..., 3.8652e+06, 4.0686e+06
14 plateau levels =      1,      1,      1,  ...,     11,     12</code></pre>
<pre class="r"><code># add group number to the blocked age
d_blk_age &lt;- d_blk_age %&gt;% 
  dplyr::mutate(
    cum_rec = cumsum(blk_sz),
    grp = cumrec_to_grp(cum_rec)
  )

# map from age to group number
age_to_grp &lt;- stepfun(
  x = c(16L, d_blk_age$age_cln), # x value is the upper/right boundary of each group
  y = c(1L, 1L, d_blk_age$grp),
  right = FALSE,
  f = 1 # use the x value to the right when interpolating
)

age_to_grp</code></pre>
<pre><code>Step function
Call: stepfun(x = c(16L, d_blk_age$age_cln), y = c(1L, 1L, d_blk_age$grp), 
    right = FALSE, f = 1)
 x[1:89] =     16,     17,     18,  ...,    103,    104
90 plateau levels =      1,      1,      1,  ...,     12,     12</code></pre>
<pre class="r"><code># add mapped group number to the blocked age to check
d_blk_age &lt;- d_blk_age %&gt;% 
  dplyr::mutate(
    grp_from_age = age_to_grp(age_cln)
  )</code></pre>
<p>Construct the (age, county) blocking variable.</p>
<pre class="r"><code># construct the (age, county) blocking variable

# updating d is probably poor form
# but I am only adding variables, so it is idempotent
d &lt;- d %&gt;% 
  dplyr::mutate(
    # create the new combined blocking variable
    blk_age_county = dplyr::if_else(excl_blk_age_county_miss,
                                    NA_character_, # make value NA for safety
                                    paste0(&quot;AgeGrp=&quot;, age_to_grp(age_cln), &quot;:County=&quot;, county_id)
    )
  )</code></pre>
<p>Characterise the newly constructed (age, county) blocking variable.</p>
<pre class="r"><code># calculate the distribution of block sizes
d_blk &lt;- d %&gt;% 
  dplyr::filter(!excl_blk_age_county_miss) %&gt;% 
  dplyr::count(blk_age_county, name = &quot;blk_sz&quot;) 

# number of blocks
nrow(d_blk)</code></pre>
<pre><code>[1] 1200</code></pre>
<pre class="r"><code># summary of distribution of block sizes
summary(d_blk$blk_sz)</code></pre>
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   44.0   912.5  1845.5  3390.5  3660.2 54013.0 </code></pre>
<pre class="r"><code># distribution of block sizes
d_blk %&gt;% 
  ggplot(aes(x = blk_sz)) +
  geom_vline(xintercept = c(blk_sz_min, blk_sz_max), colour = &quot;blue&quot;) +
  # geom_jitter(width = 0.35, alpha = 0.2) +
  geom_histogram(bins = 20, boundary = log10(blk_sz_max), alpha = 0.5) +
  geom_rug(colour = &quot;dark grey&quot;, alpha = 0.5) +
  geom_boxplot(outlier.shape = NA, colour = &quot;red&quot;, alpha = 0, size = 1, width = 5) +
  scale_x_log10(n.breaks = 7) + annotation_logticks(sides = &quot;b&quot;) +
  theme(panel.grid.minor.x = element_blank()) + 
  xlab(&quot;Block size (records)&quot;) + ylab(&quot;Count (blocks)&quot;)</code></pre>
<p><img src="figure/02-2_mk_block_vars.Rmd/unnamed-chunk-10-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-10-1">
Past versions of unnamed-chunk-10-1.png
</button>
</p>
<div id="fig-unnamed-chunk-10-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/rgayler/fa_sim_cal/blob/0d30c5bdc45b74957e36aec8f0b95ae7080f36c9/docs/figure/02-2_mk_block_vars.Rmd/unnamed-chunk-10-1.png" target="_blank">0d30c5b</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-01-26
</td>
</tr>
</tbody>
</table>
</div>
</div>
<ul>
<li><p>1200 blocks</p></li>
<li><p>~99.8%% of blocks in the useful size range and covering the entire
useful range</p>
<ul>
<li>Only two blocks just outside the useful block size range</li>
<li>Minimum block size: 44 records</li>
<li>Maximum block size: 54,013 records</li>
</ul></li>
<li><p>Mean block size (most relevant for computational effort): ~3.4k
records</p></li>
<li><p>The block sizes are concentrated in the middle of the useful range
(on a logarithmic size scale)</p>
<ul>
<li>Median block size ~1.8k records</li>
</ul></li>
</ul>
</div>
<div id="sex-age-county" class="section level1" number="6">
<h1><span class="header-section-number">6</span> (sex, age, county)</h1>
<p>There are 5,127 (31%) blocks in (sex, age, county) that are too small.
None are too large and the largest block is significantly smaller than
the upper bound on useful block size. I hope this can be fixed with some
aggressive pooling.</p>
<p>Both age and county are able to be pooled. The ordering of age is
meaningful so it makes most sense to pool adjacent age values to
maintain the ordering. The county IDs are not ordered, so there is no
obvious constraint on which counties should be pooled.</p>
<p>Prefer to pool age because the basis of pooling is clear. The fraction
of records at each age is never large, so we have good control over the
boundaries between pooled ages.</p>
<pre class="r"><code># get the unpooled block sizes for (sex, age, county), (sex, age), age, and county
d_blk_sex_age_county &lt;- d %&gt;% 
  dplyr::filter(!excl_blk_sex_age_county_miss) %&gt;% 
  dplyr::count(sex, age_cln, county_id, name = &quot;blk_sz&quot;) 
summary(d_blk_sex_age_county$blk_sz)</code></pre>
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
    1.0    38.0   109.0   242.6   259.0  5739.0 </code></pre>
<pre class="r"><code>d_blk_sex_county &lt;- d %&gt;% 
  dplyr::filter(!excl_blk_sex_age_county_miss) %&gt;% 
  dplyr::count(sex, county_id, name = &quot;blk_sz&quot;) 
summary(d_blk_sex_county$blk_sz)</code></pre>
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
    435    5831   10799   20265   24066  226197 </code></pre>
<p>For (sex, county), the maximum block size is 226,197 records and the minimum
block size is 435 records.</p>
<ul>
<li><p>To reduce the maximum block size to 50k records we need to combine
it with an age group with no more than 50,000 / 226,197 =
22% of the records.</p></li>
<li><p>To reduce the minimum block size to 50 records we need to combine it
with an age group with no less than 50 / 435 =
12% of the records.</p></li>
<li><p>The previous points assume that sex, age, and county are independent,
which is unlikely to be exactly true. So the figures calculated here
should be regarded as back of the envelope approximations.</p></li>
<li><p>The largest pooled age group is 22% of records and the smallest is
12%. That leaves 66% of the records to be distributed over the pooled
groups of intermediate size.</p>
<ul>
<li>The intermediate pooled groups can’t be larger than the largest
group, so there must be at least ceiling(66 / 22) =
3 intermediate groups.</li>
<li>The intermediate pooled groups can’t be smaller than the
smallest group, so there must be no more than floor(66 / 12) =
5 intermediate groups.</li>
</ul></li>
<li><p>So, there must be between 3 and 5 intermediate pooled age groups.</p>
<ul>
<li>Use 10 intermediate groups because experimentation shows this
gives pleasing results with the following code.</li>
</ul></li>
<li><p>Aim for the intermediate group sizes to be equally spaced on a
linear probability scale between the sizes of the largest and
smallest pooled groups.</p>
<ul>
<li>The age groups are smaller for the higher ages, so make the
smallest pooled age group correspond to the highest ages to
provide finer control of the pooled group boundaries where the
pooled groups are smallest.</li>
</ul></li>
</ul>
<p>The target boundaries for the age groups are calculated as follows:</p>
<pre class="r"><code>n_grp &lt;- 4 + 1 + 1 # 10 intermediate + 1 largest + 1 smallest

n_rec &lt;- sum(d_blk_age$blk_sz) # number of records

p_max &lt;- 0.22 # fraction of records in largest group
p_min &lt;- 0.12 # fraction of records in smallest group

groups &lt;- tibble::tibble(
  grp = 1:n_grp
)

groups &lt;- groups %&gt;% 
  dplyr::mutate(
    p_raw = # raw fraction of records in each group (do NOT sum to 1)
      seq(from = p_max, to = p_min, length.out = n_grp), # intermediate probs equally spaced on linear scale
    
    p_grp = # fraction of records in each group (normalised to sum to 1)
      dplyr::if_else(grp %in% c(1, n_grp),
                     p_raw,
                     (1.0 - (p_max + p_min)) * p_raw / (sum(p_raw) - (p_max + p_min))
      ),
    
    p_cum = # cumulative fraction of records at the top boundary of each group
      cumsum(p_grp),
    
    rec_cut = # nearest record to group boundary
      round(p_cum * n_rec)
  )

# look at the results of the group size calculation
groups %&gt;% 
  knitr::kable(format.args = list(big.mark = &quot;,&quot;))</code></pre>
<table>
<thead>
<tr class="header">
<th align="right">grp</th>
<th align="right">p_raw</th>
<th align="right">p_grp</th>
<th align="right">p_cum</th>
<th align="right">rec_cut</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">0.22</td>
<td align="right">0.2200000</td>
<td align="right">0.2200000</td>
<td align="right">895,102</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">0.20</td>
<td align="right">0.1941176</td>
<td align="right">0.4141176</td>
<td align="right">1,684,897</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">0.18</td>
<td align="right">0.1747059</td>
<td align="right">0.5888235</td>
<td align="right">2,395,713</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">0.16</td>
<td align="right">0.1552941</td>
<td align="right">0.7441176</td>
<td align="right">3,027,550</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="right">0.14</td>
<td align="right">0.1358824</td>
<td align="right">0.8800000</td>
<td align="right">3,580,407</td>
</tr>
<tr class="even">
<td align="right">6</td>
<td align="right">0.12</td>
<td align="right">0.1200000</td>
<td align="right">1.0000000</td>
<td align="right">4,068,644</td>
</tr>
</tbody>
</table>
<p>Now construct functions to map from age to pooled age group.</p>
<pre class="r"><code># map from cumulative record number to group number
cumrec_to_grp &lt;- stepfun(
  x = c(1L, groups$rec_cut), # x value is the upper/right boundary of each group
  y = c(1L, 1L, groups$grp),
  right = FALSE,
  f = 1 # use the x value to the right when interpolating
)

cumrec_to_grp</code></pre>
<pre><code>Step function
Call: stepfun(x = c(1L, groups$rec_cut), y = c(1L, 1L, groups$grp), 
    right = FALSE, f = 1)
 x[1:7] =      1, 8.951e+05, 1.6849e+06,  ..., 3.5804e+06, 4.0686e+06
8 plateau levels =      1,      1,      1,  ...,      5,      6</code></pre>
<pre class="r"><code># add group number to the blocked age
d_blk_age &lt;- d_blk_age %&gt;% 
  dplyr::mutate(
    cum_rec = cumsum(blk_sz),
    grp = cumrec_to_grp(cum_rec)
  )

# map from age to group number
age_to_grp &lt;- stepfun(
  x = c(16L, d_blk_age$age_cln), # x value is the upper/right boundary of each group
  y = c(1L, 1L, d_blk_age$grp),
  right = FALSE,
  f = 1 # use the x value to the right when interpolating
)

age_to_grp</code></pre>
<pre><code>Step function
Call: stepfun(x = c(16L, d_blk_age$age_cln), y = c(1L, 1L, d_blk_age$grp), 
    right = FALSE, f = 1)
 x[1:89] =     16,     17,     18,  ...,    103,    104
90 plateau levels =      1,      1,      1,  ...,      6,      6</code></pre>
<pre class="r"><code># add mapped group number to the blocked age to check
d_blk_age &lt;- d_blk_age %&gt;% 
  dplyr::mutate(
    grp_from_age = age_to_grp(age_cln)
  )</code></pre>
<p>Construct the (age, county) blocking variable.</p>
<pre class="r"><code># construct the (age, county) blocking variable

# updating d is probably poor form
# but I am only adding variables, so it is idempotent
d &lt;- d %&gt;% 
  dplyr::mutate(
    # create the new combined blocking variable
    blk_sex_age_county = dplyr::if_else(excl_blk_sex_age_county_miss,
                                    NA_character_, # make value NA for safety
                                    paste0(&quot;Sex=&quot;, sex, &quot;:AgeGrp=&quot;, age_to_grp(age_cln), &quot;:County=&quot;, county_id)
    )
  )</code></pre>
<p>Characterise the newly constructed (age, county) blocking variable.</p>
<pre class="r"><code># calculate the distribution of block sizes
d_blk &lt;- d %&gt;% 
  dplyr::filter(!excl_blk_sex_age_county_miss) %&gt;% 
  dplyr::count(blk_sex_age_county, name = &quot;blk_sz&quot;) 

# number of blocks
nrow(d_blk)</code></pre>
<pre><code>[1] 1200</code></pre>
<pre class="r"><code># summary of distribution of block sizes
summary(d_blk$blk_sz)</code></pre>
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   45.0   942.8  1835.0  3377.6  3744.0 51009.0 </code></pre>
<pre class="r"><code># distribution of block sizes
d_blk %&gt;% 
  ggplot(aes(x = blk_sz)) +
  geom_vline(xintercept = c(blk_sz_min, blk_sz_max), colour = &quot;blue&quot;) +
  # geom_jitter(width = 0.35, alpha = 0.2) +
  geom_histogram(bins = 20, boundary = log10(blk_sz_max), alpha = 0.5) +
  geom_rug(colour = &quot;dark grey&quot;, alpha = 0.5) +
  geom_boxplot(outlier.shape = NA, colour = &quot;red&quot;, alpha = 0, size = 1, width = 5) +
  scale_x_log10(n.breaks = 7) + annotation_logticks(sides = &quot;b&quot;) +
  theme(panel.grid.minor.x = element_blank()) + 
  xlab(&quot;Block size (records)&quot;) + ylab(&quot;Count (blocks)&quot;)</code></pre>
<p><img src="figure/02-2_mk_block_vars.Rmd/unnamed-chunk-15-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-15-1">
Past versions of unnamed-chunk-15-1.png
</button>
</p>
<div id="fig-unnamed-chunk-15-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://github.com/rgayler/fa_sim_cal/blob/0d30c5bdc45b74957e36aec8f0b95ae7080f36c9/docs/figure/02-2_mk_block_vars.Rmd/unnamed-chunk-15-1.png" target="_blank">0d30c5b</a>
</td>
<td>
Ross Gayler
</td>
<td>
2021-01-26
</td>
</tr>
</tbody>
</table>
</div>
</div>
<ul>
<li><p>1200 blocks</p></li>
<li><p>~99.8%% of blocks in the useful size range and covering the entire
useful range</p>
<ul>
<li>Only two blocks lie just outside the useful block size range</li>
<li>Minimum block size: 45 records</li>
<li>Maximum block size: 51,009 records</li>
</ul></li>
<li><p>Mean block size (most relevant for computational effort): ~3.4k
records</p></li>
<li><p>The block sizes are concentrated in the middle of the useful range
(on a logarithmic size scale)</p>
<ul>
<li>Median block size ~1.8k records</li>
</ul></li>
</ul>
</div>
<div id="save-enity-blocking-variables" class="section level1" number="7">
<h1><span class="header-section-number">7</span> Save enity blocking variables</h1>
<p>Save the blocking variables as a separate file that can be joined to the clean entity data.</p>
<pre class="r"><code># Show the clean data file location
# This is set in code/file_paths.R
fs::path_file(f_entity_blk_fst)</code></pre>
<pre><code>[1] &quot;ent_blk.fst&quot;</code></pre>
<pre class="r"><code># save the entity blocking variables (cheap-skate caching)
d %&gt;% 
  dplyr::select(id, starts_with(c(&quot;excl_blk_&quot;, &quot;blk_&quot;))) %&gt;% 
  fst::write_fst(f_entity_blk_fst, compress = 100) %&gt;% 
  dplyr::glimpse()</code></pre>
<pre><code>Rows: 4,099,699
Columns: 7
$ id                           &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 1…
$ excl_blk_age_county_miss     &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE…
$ excl_blk_sex_age_miss        &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE…
$ excl_blk_sex_age_county_miss &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE…
$ blk_sex_age                  &lt;chr&gt; &quot;Sex=MALE:AgeGrp=43&quot;, &quot;Sex=MALE:AgeGrp=5…
$ blk_age_county               &lt;chr&gt; &quot;AgeGrp=5:County=5&quot;, &quot;AgeGrp=7:County=8&quot;…
$ blk_sex_age_county           &lt;chr&gt; &quot;Sex=MALE:AgeGrp=3:County=5&quot;, &quot;Sex=MALE:…</code></pre>
</div>
<div id="characterise-the-blocks" class="section level1" number="8">
<h1><span class="header-section-number">8</span> Characterise the blocks</h1>
<p>Characterise the blocks. This may be useful later for selecting the blocks to use.</p>
<pre class="r"><code># function to characterise the contents of 1 block
char_1_block &lt;- function(
  .x, # data frame containing all the records of one block
  .y  # one-row data frame - the grouping key (must be one-column only)
  # value: a data frame of one row giving all the summary statistics for the block
) {
  tibble::tibble(
    blk_id = .y[[1]],
    blk_sz = nrow(.x),
    sex_p_female = sum(.x$sex == &quot;FEMALE&quot;) / blk_sz,
    sex_n = .x$sex %&gt;% unique() %&gt;% length(),
    sex_n_eff = .x$sex %&gt;% n_eff(),
    age_mean = mean(.x$age_cln),
    age_min = min(.x$age_cln),
    age_max = max(.x$age_cln),
    age_range = age_max - age_min + 1,
    county_n = .x$county_id %&gt;% unique() %&gt;% length(),
    county_n_eff = .x$county_id %&gt;% n_eff()
  )
}

# Function to calculate the effective number of levels of a categorical variable
# Based on Shannon entropy
# This is the number of levels a uniformly distributed variable would need to have the same entropy
n_eff &lt;- function (
  x # vector of discrete levels
) {
  p &lt;- table(x) %&gt;% prop.table() %&gt;% as.vector() # probabilities of levels
  -sum( p * log(p)) %&gt;% exp()
}

# characterise each of the blocks created by each of the blocking variables
# and put all the results in a single data frame
d_blks &lt;- dplyr::bind_rows(
  list(
    blk_sex_age = d %&gt;% 
      dplyr::filter(!excl_blk_sex_age_miss) %&gt;% 
      dplyr::group_by(blk_sex_age) %&gt;% 
      group_modify(char_1_block) %&gt;% 
      dplyr::ungroup() %&gt;% 
      dplyr::select(-blk_sex_age),
    
    blk_age_county = d %&gt;% 
      dplyr::filter(!excl_blk_age_county_miss) %&gt;% 
      dplyr::group_by(blk_age_county) %&gt;% 
      group_modify(char_1_block) %&gt;% 
      dplyr::ungroup() %&gt;% 
      dplyr::select(-blk_age_county),
    
    blk_sex_age_county = d %&gt;% 
      dplyr::filter(!excl_blk_sex_age_county_miss) %&gt;% 
      dplyr::group_by(blk_sex_age_county) %&gt;% 
      group_modify(char_1_block) %&gt;% 
      dplyr::ungroup() %&gt;% 
      dplyr::select(-blk_sex_age_county)
  ),
  .id = &quot;blk_var&quot;
)</code></pre>
</div>
<div id="save-the-block-characterisations" class="section level1" number="9">
<h1><span class="header-section-number">9</span> Save the block characterisations</h1>
<p>Save the characterisation of each block created by each blocking variable.</p>
<pre class="r"><code># Show the clean data file location
# This is set in code/file_paths.R
fs::path_file(f_blk_char.fst)</code></pre>
<pre><code>[1] &quot;blk_char.fst&quot;</code></pre>
<pre class="r"><code># save the entity blocking variables (cheap-skate caching)
d_blks %&gt;% 
  fst::write_fst(f_blk_char.fst, compress = 100) %&gt;% 
  dplyr::glimpse()</code></pre>
<pre><code>Rows: 2,568
Columns: 12
$ blk_var      &lt;chr&gt; &quot;blk_sex_age&quot;, &quot;blk_sex_age&quot;, &quot;blk_sex_age&quot;, &quot;blk_sex_ag…
$ blk_id       &lt;chr&gt; &quot;Sex=FEMALE:AgeGrp=100&quot;, &quot;Sex=FEMALE:AgeGrp=101&quot;, &quot;Sex=F…
$ blk_sz       &lt;int&gt; 320, 831, 10539, 35091, 36470, 36216, 35495, 36632, 3643…
$ sex_p_female &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ sex_n        &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ sex_n_eff    &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ age_mean     &lt;dbl&gt; 100.00000, 102.27918, 17.99782, 19.00000, 20.00000, 21.0…
$ age_min      &lt;int&gt; 100, 101, 17, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29…
$ age_max      &lt;int&gt; 100, 104, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29…
$ age_range    &lt;dbl&gt; 1, 4, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ county_n     &lt;int&gt; 82, 90, 97, 99, 100, 100, 100, 100, 100, 100, 100, 100, …
$ county_n_eff &lt;dbl&gt; 53.31918, 35.16054, 59.06182, 50.52109, 51.31101, 52.430…</code></pre>
</div>
<div id="timing" class="section level1 unnumbered">
<h1>Timing</h1>
<pre><code>Computation time (excl. render): 30.364 sec elapsed</code></pre>
<br>
<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-sessioninfo" data-toggle="collapse" data-target="#workflowr-sessioninfo" style="display: block;">
<span class="glyphicon glyphicon-wrench" aria-hidden="true"></span>
Session information
</button>
</p>
<div id="workflowr-sessioninfo" class="collapse">
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>R version 4.0.3 (2020-10-10)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 20.10

Matrix products: default
BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0
LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.9.0

locale:
 [1] LC_CTYPE=en_AU.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_AU.UTF-8        LC_COLLATE=en_AU.UTF-8    
 [5] LC_MONETARY=en_AU.UTF-8    LC_MESSAGES=en_AU.UTF-8   
 [7] LC_PAPER=en_AU.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_AU.UTF-8 LC_IDENTIFICATION=C       

attached base packages:
[1] stats     graphics  grDevices datasets  utils     methods   base     

other attached packages:
 [1] knitr_1.30      fst_0.9.4       fs_1.5.0        forcats_0.5.0  
 [5] stringr_1.4.0   dplyr_1.0.3     purrr_0.3.4     readr_1.4.0    
 [9] tidyr_1.1.2     tibble_3.0.5    ggplot2_3.3.3   tidyverse_1.3.0
[13] tictoc_1.0      here_1.0.1      workflowr_1.6.2

loaded via a namespace (and not attached):
 [1] Rcpp_1.0.6        lubridate_1.7.9.2 utf8_1.1.4        assertthat_0.2.1 
 [5] rprojroot_2.0.2   digest_0.6.27     R6_2.5.0          cellranger_1.1.0 
 [9] backports_1.2.1   reprex_0.3.0      evaluate_0.14     highr_0.8        
[13] httr_1.4.2        pillar_1.4.7      rlang_0.4.10      readxl_1.3.1     
[17] rstudioapi_0.13   data.table_1.13.6 whisker_0.4       rmarkdown_2.6    
[21] labeling_0.4.2    munsell_0.5.0     broom_0.7.3       compiler_4.0.3   
[25] httpuv_1.5.5      modelr_0.1.8      xfun_0.20         pkgconfig_2.0.3  
[29] htmltools_0.5.1.1 tidyselect_1.1.0  bookdown_0.21     fansi_0.4.2      
[33] crayon_1.3.4      dbplyr_2.0.0      withr_2.4.0       later_1.1.0.1    
[37] grid_4.0.3        jsonlite_1.7.2    gtable_0.3.0      lifecycle_0.2.0  
[41] DBI_1.1.1         git2r_0.28.0      magrittr_2.0.1    scales_1.1.1     
[45] cli_2.2.0         stringi_1.5.3     farver_2.0.3      renv_0.12.5      
[49] promises_1.1.1    xml2_1.3.2        ellipsis_0.3.1    generics_0.1.0   
[53] vctrs_0.3.6       tools_4.0.3       glue_1.4.2        hms_1.0.0        
[57] parallel_4.0.3    yaml_2.2.1        colorspace_2.0-0  rvest_0.3.6      
[61] haven_2.3.1      </code></pre>
</div>
</div>


<!-- Adjust MathJax settings so that all math formulae are shown using
TeX fonts only; see
http://docs.mathjax.org/en/latest/configuration.html.  This will make
the presentation more consistent at the cost of the webpage sometimes
taking slightly longer to load. Note that this only works because the
footer is added to webpages before the MathJax javascript. -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>




</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3,h4,h5",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "site_libs/mathjax-local/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
